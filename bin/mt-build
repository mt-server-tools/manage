#!/bin/bash

# $(cat /proc/cpuinfo | grep -P '^processor\s*:' -c)

# TODO make these configurable

TARGETDIR=minetest-"$(date "+%F")"
NUMPROCESSORS=1
RMCOMPILER=1

# =============================
if [[ "$*" =~ --help ]]; then
cat <<EOHELP
This script will download a fresh minetest and minetest_game and build it with LevelDB support

It will be placed in a ./minetest-\$DATE folder with the current date.
EOHELP
exit
fi
# =============================

# unlikely to change
MTGITURL=https://github.com/minetest/minetest
MTGAMEGITURL=https://github.com/minetest/minetest_game

# Build minetest from source

echo "[1;33mInstalling build components[0m"

# run install
REMOVALCMD="echo You must remove: "
if which apt-get >/dev/null; then # should work for both Debian and Ubuntu
	sudo apt-get update && sudo apt-get install build-essential cmake git libirrlicht-dev libbz2-dev libgettextpo-dev libfreetype6-dev libpng12-dev libjpeg-dev libxxf86vm-dev libgl1-mesa-dev libsqlite3-dev libogg-dev libvorbis-dev libopenal-dev libhiredis-dev libcurl3-dev libncurses5-dev libleveldb-dev libleveldb1v5
	REMOVALCMD="apt-get remove gcc"
elif which yum >/dev/null && grep CentOS /etc/lsb-release -q; then # check for Fedora too
	echo "[1;31mCentOS not supported yet[0m"
	exit 2
elif which pacman >/dev/null; then
	echo "[1;31mArch not supported yet[0m"
	exit 2
else
	echo "[1;31mYour distro is not supported yet[0m"
	exit 2
fi

if [[ ! -d "$TARGETDIR" ]]; then
	git clone "$MTGITURL" "$TARGETDIR"
	cd "$TARGETDIR"
else
	cd "$TARGETDIR"
	git pull origin master
fi

mkdir -p games/
cd games
git clone "$MTGAMEGITURL"
cd ..
cp minetest.conf.example minetest.conf

# TODO - put these build options in mt-manage.conf
cmake -DRUN_IN_PLACE=1 -DBUILD_CLIENT=0 -DBUILD_SERVER=1 -DENABLE_CURL=1 -DENABLE_CURSES=0 -DENABLE_REDIS=0 -DENABLE_LEVELDB=1

# Make game, if successful, remove the make configuration so next build is fresh
make -j "$NUMPROCESSORS" && rm -r CMakeFiles/
EXEDIR=$(dirname "$0")
cp "../$EXEDIR/mt-run" "bin/" # a run-in-place script to be run inside tmux; need to replace with service file

if [[ "$RMCOMPILER" == 1 ]]; then
	# ------- do not leave C compiler lying around on an Internet-attached machine!
	# what else?
	echo "[1;33mRemoving compiler[0m"
	sudo $REMOVALCMD
fi

if [[ "$(free|grep -i swap|awk '{print $2}')" -lt 1 ]]; then
	swapsize=$(uask "You have no swap - please specify the # of MB of swap to configure (eg. 1000 for a gigabyte), or leave emtpy to configure no swap.")
	if [[ "$swapsize" =~ $(echo '^[0-9]+$') ]]; then
		(
		mkdir /swaps
		cd /swaps
		dd if=/dev/zero of="./swap1" bs=$(( 1024 * 1024 )) count=$swapsize && {
			chown root:root ./swap1
			chmod 600 ./swap1
			mkswap ./swap1
			swapon ./swap1
			export $(blkid swap1|grep -o -P 'UUID=\S+'|sed 's/"//g')
			echo "$UUID swap swap defaults 0 0" >> /etc/fstab
		}
		)
	fi
fi
