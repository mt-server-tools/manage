#!/bin/bash

# $(cat /proc/cpuinfo | grep -P '^processor\s*:' -c)
# TODO make this a configurable option
NUMPROCESSORS=1
RMCOMPILER=1
MTGITURL=https://github.com/minetest/minetest
MTGAMEGITURL=https://github.com/minetest/minetest_game

# Build minetest from source

echo "[1;33mInstalling build components[0m"
sudo apt-get update && sudo apt-get install build-essential cmake git libirrlicht-dev libbz2-dev libgettextpo-dev libfreetype6-dev libpng12-dev libjpeg-dev libxxf86vm-dev libgl1-mesa-dev libsqlite3-dev libogg-dev libvorbis-dev libopenal-dev libhiredis-dev libcurl3-dev libncurses5-dev

git clone "$MTGITURL" minetest
cd minetest

mkdir games/
cd games
git clone "$MTGAMEGITURL"
cd ..

cmake -DRUN_IN_PLACE=1 -DBUILD_SERVER=1 -DENABLE_CURL=1 -DENABLE_CURSES=0 -DENABLE_REDIS=0 -DENABLE_LEVELDB=1

# Make game, if successful, remove the make configuration so next build is fresh
make -j "$NUMPROCESSORS" && rm -r CMakeFiles

if [[ "$RMCOMPILER" == 1 ]]; then
	# ------- do not leave C compiler lying around on an Internet-attached machine!
	# what else?
	echo "[1;33mRemoving compiler[0m"
	sudo apt-get remove gcc
fi

# TODO adapt the mt-* tools to load the appropriate configs and paths
# add support for adding a systemd service file


